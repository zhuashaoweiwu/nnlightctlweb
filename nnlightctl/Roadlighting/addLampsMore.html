<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>部署 -- 批量添加灯具</title>
    <link rel="stylesheet" type="text/css" href="../css/common.css" />
    <link rel="stylesheet" type="text/css" href="../css/admin.css" />
    <link rel="stylesheet" type="text/css" href="../css/iconfont/iconfont.css" />

</head>
<body>
    <article class="page-container">
        <form class="form form-horizontal" id="form-admin-add">
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>灯具起始唯一编码：</label>
                <div class="formControls col-xs-8 col-sm-2">
                    <input type="text" class="input-text" value="" placeholder="灯具起始唯一编码" id="startLightCode" name="startLightCode">
                </div>
                <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>数量：</label>
                <div class="formControls col-xs-8 col-sm-2">
                    <input type="text" class="input-text" value="" placeholder="数量" id="count" name="count">
                </div>
                <label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>每次递增：</label>
                <div class="formControls col-xs-8 col-sm-2">
                    <input type="text" class="input-text" value="" placeholder="每次递增" id="step" name="step">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">生产日期：</label>
                <div class="formControls col-xs-8 col-sm-9" style="width:200px;">
                    <input type="text" class="input-text Wdate" onfocus="WdatePicker({ maxDate:'#F{$dp.$D(\'manufacture\')||\'%y-%M-%d\'}' })" value="" placeholder="灯具生产日期" id="manufacture" name="manufacture">
                </div>
            </div>

            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">安装日期：</label>
                <div class="formControls col-xs-8 col-sm-9" style="width:200px;">
                    <input type="text" class="input-text Wdate" onfocus="WdatePicker({ maxDate:'#F{$dp.$D(\'useDate\')||\'%y-%M-%d\'}' })" value="" placeholder="灯具使用日期" id="useDate" name="useDate">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>灯杆：</label>
                <div class="formControls col-xs-8 col-sm-9" style="width:200px;">
                    <input type="text" class="input-text" value="" placeholder="灯杆" id="lamppost" name="lamppost">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>灯头号：</label>
                <div class="formControls col-xs-8 col-sm-9" style="width:200px;">
                    <input type="text" class="input-text" value="" placeholder="灯头号" id="lamphead" name="lamphead">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>灯具型号：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <span class="select-box" style="width:150px;">
                        <select class="select" name="nnlightctlLightingModelId" id="nnlightctlLightingModelId" size="1">
                            <option value="0">灯具型号一</option>
                            <option value="1">灯具型号二</option>
                        </select>
                    </span>
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">经度：</label>
                <div class="formControls col-xs-8 col-sm-9" style="width:200px;">
                    <input type="text" class="input-text" value="" placeholder="经度" id="longitude" name="longitude">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">纬度：</label>
                <div class="formControls col-xs-8 col-sm-9" style="width:200px;">
                    <input type="text" class="input-text" value="" placeholder="纬度" id="latitude" name="latitude">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">资产编号：</label>
                <div class="formControls col-xs-8 col-sm-9" style="width:200px;">
                    <input type="text" class="input-text" value="" placeholder="资产编号" id="propertySerialNumber" name="propertySerialNumber">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">最大使用时间（年）：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <input type="text" class="input-text" value="" placeholder="最大使用时间" id="maxUseTime" name="maxUseTime">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">光衰：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <input type="text" class="input-text" value="" placeholder="光衰" id="decay" name="decay">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">灯具区域：</label>
                <div class="formControls col-xs-8 col-sm-9" style="width:400px;">
                    <input type="text" class="input-text" value="" placeholder="灯具区域" id="regionLevelDesc" name="regionLevelDesc">
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">&nbsp;备注：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <textarea cols="" rows="" class="textarea" placeholder="说点什么...100个字符以内" dragonfly="true" id="mem" name="mem"></textarea>
                    <p class="textarea-numberbar"><em class="textarea-length">0</em>/100</p>
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>所属项目：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <span class="select-box" style="width:150px;">
                        <select class="select" name="nnlightctlProjectId" id="nnlightctlProjectId" size="1">
                            <option value="0">项目一</option>
                            <option value="1">项目二</option>
                        </select>
                    </span>
                </div>
            </div>
            <div class="row cl">
                <div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-3">
                    <input class="btn btn-primary radius" type="submit" value="&nbsp;&nbsp;提交&nbsp;&nbsp;">
                </div>
            </div>
            <input type="hidden" id="nnlightctlRegionId" name="nnlightctlRegionId" />
        </form>
    </article>
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/layer/2.4/layer.js"></script>
    <script type="text/javascript" src="../js/common.js"></script>
    <script type="text/javascript" src="../lib/My97DatePicker/4.8/WdatePicker.js"></script> <!--日期插件-->

    <script type="text/javascript" src="../js/api/requestRoot.js"></script>
    <script type="text/javascript" src="../js/api/ajaxScript.js"></script>

    <script type="text/javascript" src="../lib/jquery.validation/1.14.0/jquery.validate.js"></script>
    <script type="text/javascript" src="../lib/jquery.validation/1.14.0/validate-methods.js"></script>
    <script type="text/javascript" src="../lib/jquery.validation/1.14.0/messages_zh.js"></script>
    <script type="text/javascript">
        $(function () {
            //注册区域文本框点击事件
            $("#regionLevelDesc").click(function () {
                layer_show("设置区域", "setArea.html", "600", "400", function (regionId) {
                    $("#regionLevelDesc").attr("regionId", regionId);
                    ajaxRequest("post", "/api/roadlighting/getAreaDescById", { "id": regionId }, function (data) {
                        if (data) {
                            if (data.header.code == 1000) {
                                debugger;
                                var regionDesc = data.body.data[0];
                                $("#nnlightctlRegionId").val(regionId);
                                $("#regionLevelDesc").val(regionDesc);
                            } else {
                                layer.msg(data.header.msg, { icon: 2, time: 3000 });
                            }
                        }
                    });
                });
            });
            //数据验证
            $("#form-admin-add").validate({
                rules: {
                    startLightCode : {
                        required : true
                    },
                    count : {
                        required : true
                    },
                    step: {
                        required: true
                    },

                    lightingCode : {
                        required : true
                    },

                    lamppost : {
                        required : true
                    },

                    lamphead : {
                        required : true
                    },

                    nnlightctlProjectId : {
                        required : true
                    },

                    nnlightctlLightingModelId : {
                        required : true
                    },
                    maxUseTime: {
                        required: true,
                        isFloat: true
                    },
                    decay: {
                        required: true,
                        isFloat: true
                    },
                },
                onkeyup: false,
                focusCleanup: true,
                success: "valid",
                submitHandler: function (form) {
                    //ajax上传表单
                    //构造上传数据
                    var startLightingCode = $("#startLightCode").val();
                    var count = $("#count").val();
                    var step = $("#step").val();
                    var addLightingArray = [];
                    for (var i = 0; i < count; ++i) {
                        var param = {};
                        var paramArray = $(form).serializeArray();
                        for (var j = 0; j < paramArray.length; ++j) {
                            var o = paramArray[j];
                            param[o["name"]] = o["value"];
                        }
                        param["manufacture"] = str2Date($("#manufacture").val().trim());
                        param["useDate"] = str2Date($("#useDate").val().trim());

                        //计算灯具唯一编码
                        param["lightingCode"] = String(parseInt(startLightingCode) + step * i);

                        addLightingArray.push(param);
                    }

                    debugger;
                    ajaxRequest("post", "/api/roadlighting/batchAddLighting", transArray({"addLightings" : addLightingArray}), function (data) {
                        if (data) {
                            if (data.header.code == 1000) {
                                layer.msg("批量添加灯具成功！", {icon: 1, time: 3000});
                            } else {
                                layer.msg(data.header.msg, {icon: 2, time: 3000});
                            }
                        }
                    });

                    // var index = parent.layer.getFrameIndex(window.name);
                    // parent.$('.btn-refresh').click();
                    // parent.layer.close(index);
                    ResetWindow();
                }
            });

            //刷新灯具型号
            function flushLightModel() {
                ajaxRequest("post", "/api/roadlighting/listLightModel", {}, function (data) {
                    if (data) {
                        if (data.header.code == 1000) {
                            var lightModelArray = data.body.data;

                            var $lightModelSelect = $("#nnlightctlLightingModelId");
                            $lightModelSelect.empty();

                            for (var i = 0; i < lightModelArray.length; ++i) {
                                var lightModel = lightModelArray[i];
                                $('<option value="'+lightModel.id+'">'+lightModel.modelName+'</option>').appendTo($lightModelSelect);
                            }
                        } else {
                            layer.msg(data.header.msg, {icon : 2, time : 3000});
                        }
                    }
                });
            }

            flushLightModel();

            //刷新项目列表
            function flushProjectSelect() {
                ajaxRequest("post", "/api/project/listproject", {}, function (data) {
                    if (data) {
                        if (data.header.code == 1000) {
                            var projectArray = data.body.data;

                            var $projectSelect = $("#nnlightctlProjectId");
                            $projectSelect.empty();

                            for (var i = 0; i < projectArray.length; ++i) {
                                var project = projectArray[i];
                                $('<option value="'+project.id+'">'+project.projectName+'</option>').appendTo($projectSelect);
                            }
                        } else {
                            layer.msg(data.header.msg, {icon : 2, time : 3000});
                        }
                    }
                });
            }

            flushProjectSelect();
        });
    </script>
</body>
</html>
